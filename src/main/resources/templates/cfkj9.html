<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£è¯€æŒ‘æˆ˜èµ› - è£è€€çºªå½•</title>
    <style>
        :root {
            --primary: #4A90E2;
            --success: #7ED321;
            --error: #FF5E5E;
            --bg: #F0F7FF;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'PingFang SC', sans-serif;
            background-color: var(--bg);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }

        .game-card {
            width: 90%; max-width: 550px;
            background: white; border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            padding: 30px; text-align: center;
            position: relative; z-index: 10;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .timer-display { font-family: monospace; font-size: 24px; font-weight: bold; color: var(--primary); background: #eef6ff; padding: 5px 15px; border-radius: 50px; }
        .score-tag { padding: 4px 10px; border-radius: 6px; color: white; font-weight: bold; font-size: 14px; }

        /* é¢˜ç›®åŒº */
        .mnemonic-display { font-size: 44px; font-weight: bold; color: var(--primary); background: #f9f9f9; padding: 25px; border-radius: 20px; margin: 10px 0; border: 3px solid #eee; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .option-btn { background: #fff; border: 2px solid #eee; padding: 15px 10px; font-size: 20px; border-radius: 15px; cursor: pointer; transition: 0.2s; }
        .option-btn.selected { border-color: var(--primary); background: #eef6ff; }
        .option-btn.is-correct-hint { border-color: var(--success) !important; background: #f0fff0 !important; }
        .option-btn.is-wrong-hit { border-color: var(--error) !important; opacity: 0.4; }
        .action-btn { background: var(--success); color: white; border: none; padding: 15px 50px; font-size: 20px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #60a917; }

        /* --- åŠ¨ç”»ç‰¹æ•ˆæ ¸å¿ƒä»£ç  --- */
        .star { position: fixed; top: -50px; color: #FFD700; font-size: 30px; pointer-events: none; z-index: 100; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        .confetti { position: fixed; width: 12px; height: 12px; top: 50vh; left: 50vw; z-index: 1000; pointer-events: none; animation: burstAndFall 4s cubic-bezier(0.1, 0.8, 0.3, 1) forwards; }
        @keyframes burstAndFall { 0% { transform: translate(0, 0) scale(0); opacity: 1; } 30% { transform: translate(var(--tx), var(--ty)) scale(1.2); opacity: 1; } 100% { transform: translate(var(--tx), 100vh) rotate(var(--tr)) scale(0.8); opacity: 0; } }

        .big-heart { position: fixed; top: 30%; left: -300px; font-size: 180px; z-index: 101; pointer-events: none; animation: heartPath 4s ease-in-out forwards; }
        @keyframes heartPath { 0% { left: -300px; transform: scale(1); } 30% { left: 50%; transform: translate(-50%, 0) scale(1.3); } 50% { left: 50%; transform: translate(-50%, 0) scale(1); } 70% { left: 50%; transform: translate(-50%, 0) scale(1.3); } 100% { left: 110vw; transform: scale(1); } }

        .hidden { display: none !important; }
        .input-group { margin: 25px 0; font-size: 20px; }
        .input-group input { width: 80px; padding: 10px; border: 3px solid var(--primary); border-radius: 12px; text-align: center; font-size: 24px; color: var(--primary); }
    </style>
</head>
<body>

<div class="game-card">
    <div id="intro-layer" style="margin-bottom:30px;">
        <div style="font-size: 80px;">ğŸ¯</div>
        <h2>å£è¯€æŒ‘æˆ˜èµ›</h2>
        <div class="input-group">
            è®¾å®šæŒ‘æˆ˜é¢˜æ•°ï¼š<input type="number" id="q-count" value="10" min="3">
        </div>
        <button class="action-btn" onclick="startChallenge()">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <div id="game-layer" class="hidden">
        <div class="status-header">
            <div class="info-row">
                <span>ç¬¬ <span id="current-idx">1</span> / <span id="total-display">10</span> é¢˜</span>
                <div style="display:flex; gap:8px">
                    <span class="score-tag" style="background:var(--success)">å¯¹: <span id="c-num">0</span></span>
                    <span class="score-tag" style="background:var(--error)">é”™: <span id="w-num">0</span></span>
                </div>
            </div>
            <div id="timer" class="timer-display">0ç§’</div>
        </div>
        <div id="mnemonic" class="mnemonic-display"></div>
        <div id="hint-msg" style="height:24px; color: var(--error); margin-bottom: 10px; font-weight: bold;"></div>
        <div id="options" class="options-grid"></div>
        <button id="submit-btn" class="action-btn" onclick="checkAnswer()">æäº¤ç­”æ¡ˆ</button>
    </div>

    <div id="win-layer" class="hidden" style="margin-bottom:20px;">
        <div style="font-size: 80px;">ğŸ–ï¸</div>
        <h2>æŒ‘æˆ˜å®Œæˆï¼</h2>
        <div style="font-size: 20px; line-height: 2;">
            <p>æ€»è€—æ—¶ï¼š<span id="final-time" style="color:var(--primary); font-weight:bold;"></span></p>
            <p>âœ… ç­”å¯¹ï¼š<span id="final-correct" style="color:var(--success); font-weight:bold;"></span></p>
            <p>âŒ ç­”é”™ï¼š<span id="final-wrong" style="color:var(--error); font-weight:bold;"></span></p>
        </div>
        <button class="action-btn" onclick="location.reload()">å†æ¥ä¸€å±€</button>
    </div>
</div>

<script>
    const numMap = ["é›¶","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"];
    const tenMap = ["","å","äºŒå","ä¸‰å","å››å","äº”å","å…­å","ä¸ƒå","å…«å"];
    let currentIdx = 0, correctCount = 0, wrongCount = 0, targetScore = 10;
    let currentCorrectAnswers = [], selectedOptions = [], isCorrectionMode = false, hasErrored = false;
    let startTime, timerInterval;

    function getStandardMnemonic(n1, n2) {
        const s = Math.min(n1, n2), l = Math.max(n1, n2), res = s * l;
        if (res < 10) return numMap[s] + numMap[l] + "å¾—" + numMap[res];
        const shi = Math.floor(res / 10), ge = res % 10;
        if (ge === 0) return numMap[s] + numMap[l] + (shi === 1 ? "ä¸€å" : tenMap[shi]);
        return numMap[s] + numMap[l] + (shi === 1 ? "å" : tenMap[shi]) + numMap[ge];
    }

    function startChallenge() {
        targetScore = parseInt(document.getElementById('q-count').value) || 10;
        document.getElementById('total-display').innerText = targetScore;
        document.getElementById('intro-layer').classList.add('hidden');
        document.getElementById('game-layer').classList.remove('hidden');
        startTime = Date.now();
        timerInterval = setInterval(() => { document.getElementById('timer').innerText = Math.floor((Date.now()-startTime)/1000) + "ç§’"; }, 1000);
        nextQuestion();
    }

    function nextQuestion() {
        if (currentIdx >= targetScore) { finishGame(); return; }
        isCorrectionMode = false; hasErrored = false; selectedOptions = [];
        document.getElementById('hint-msg').innerText = "";
        document.getElementById('submit-btn').innerText = "æäº¤ç­”æ¡ˆ";
        document.getElementById('submit-btn').style.background = "var(--success)";
        document.getElementById('current-idx').innerText = currentIdx + 1;
        const a = Math.floor(Math.random()*8)+2, b = Math.floor(Math.random()*8)+2;
        document.getElementById('mnemonic').innerText = getStandardMnemonic(a, b);
        const res = a * b;
        const correctPool = [`${a} Ã— ${b} = ${res}`, `${b} Ã— ${a} = ${res}`, `${res} Ã· ${a} = ${b}`, `${res} Ã· ${b} = ${a}`];
        currentCorrectAnswers = [...new Set(correctPool)].sort(()=>0.5-Math.random()).slice(0, Math.floor(Math.random()*2)+2);
        const container = document.getElementById('options');
        container.innerHTML = '';
        const distractors = new Set();
        while(distractors.size < (6-currentCorrectAnswers.length)) {
            let wa = Math.floor(Math.random()*8)+2, wb = Math.floor(Math.random()*8)+2;
            let opt = `${wa} Ã— ${wb} = ${wa*wb}`; if(!correctPool.includes(opt)) distractors.add(opt);
        }
        [...currentCorrectAnswers, ...distractors].sort(()=>0.5-Math.random()).forEach(text => {
            const btn = document.createElement('div'); btn.className = 'option-btn'; btn.innerText = text;
            btn.onclick = () => {
                if(isCorrectionMode) {
                    if(currentCorrectAnswers.includes(text)) {
                        btn.classList.add('is-correct-hint');
                        if(document.querySelectorAll('.is-correct-hint').length === currentCorrectAnswers.length) { currentIdx++; checkMilestones(); setTimeout(nextQuestion, 600); }
                    }
                } else { btn.classList.toggle('selected'); selectedOptions = Array.from(document.querySelectorAll('.option-btn.selected')).map(b=>b.innerText); }
            };
            container.appendChild(btn);
        });
    }

    // æ£€æŸ¥å¹¶è§¦å‘é˜¶æ®µå¥–åŠ±
    function checkMilestones() {
        const milestone1 = Math.floor(targetScore / 3);
        const milestone2 = Math.floor(targetScore * 2 / 3);

        if (currentIdx === milestone1) triggerStars();
        if (currentIdx === milestone2) triggerHeart();
    }

    function checkAnswer() {
        if (isCorrectionMode || selectedOptions.length === 0) return;
        if (selectedOptions.length === currentCorrectAnswers.length && selectedOptions.every(v => currentCorrectAnswers.includes(v))) {
            correctCount++; document.getElementById('c-num').innerText = correctCount;
            currentIdx++;
            checkMilestones(); // æ­£ç¡®æ—¶æ£€æŸ¥è¿›åº¦
            nextQuestion();
        } else {
            if(!hasErrored) { wrongCount++; document.getElementById('w-num').innerText = wrongCount; hasErrored = true; }
            isCorrectionMode = true; document.getElementById('hint-msg').innerText = "è¯·ç‚¹äº®æ­£ç¡®ç­”æ¡ˆçº é”™ï¼";
            document.getElementById('submit-btn').innerText = "çº é”™å­¦ä¹ "; document.getElementById('submit-btn').style.background = "#ccc";
            document.querySelectorAll('.option-btn').forEach(b => { b.classList.remove('selected'); if(!currentCorrectAnswers.includes(b.innerText)) b.classList.add('is-wrong-hit'); });
        }
    }

    function triggerStars() {
        for(let i=0; i<40; i++) {
            setTimeout(() => {
                const s = document.createElement('div'); s.className = 'star'; s.innerText = 'â­';
                s.style.left = Math.random() * 100 + 'vw';
                s.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
                document.body.appendChild(s);
                setTimeout(() => s.remove(), 4000);
            }, i * 100);
        }
    }

    function triggerHeart() {
        const h = document.createElement('div'); h.className = 'big-heart'; h.innerText = 'ğŸ’—';
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 4100);
    }

    function finishGame() {
        clearInterval(timerInterval);
        triggerVictory();
        setTimeout(() => {
            document.getElementById('game-layer').classList.add('hidden');
            document.getElementById('win-layer').classList.remove('hidden');
            document.getElementById('final-time').innerText = document.getElementById('timer').innerText;
            document.getElementById('final-correct').innerText = correctCount + " é“";
            document.getElementById('final-wrong').innerText = wrongCount + " é“";
        }, 4500);
    }

    function triggerVictory() {
        for(let j=0; j<3; j++) {
            setTimeout(() => {
                for(let i=0; i<80; i++) {
                    const c = document.createElement('div'); c.className = 'confetti';
                    c.style.background = `hsl(${Math.random()*360}, 80%, 60%)`;
                    const a = Math.random()*Math.PI*2, v = 100+Math.random()*250;
                    c.style.setProperty('--tx', Math.cos(a)*v+"vw"); c.style.setProperty('--ty', Math.sin(a)*v-100+"px");
                    c.style.setProperty('--tr', Math.random()*1000+"deg"); document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }
            }, j*1000);
        }
    }
</script>
</body>
</html>